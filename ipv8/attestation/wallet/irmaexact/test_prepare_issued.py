import base64
import binascii
import json
import random
import sys
import time
import urllib3

# Run with `QT_QUICK_BACKEND=software` for software rendering
# Ex:
#  QT_QUICK_BACKEND=software python -m ipv8.attestation.wallet.irmaexact.test_prepare_issued
from PyQt5.QtCore import *
from PyQt5.QtWidgets import QApplication, QTextEdit, QMainWindow
from PyQt5.QtWebEngineWidgets import *

from .builder import BuildDistributedProofList, Challenge, CredentialBuilder, IssueCommitmentMessage, Verify
from .keys import DefaultSystemParameters, GenerateKeyPair, PublicKey
from .proofs import ProofP, ProofPCommitment


my_app = QApplication(sys.argv)
my_web = QWebEngineView()
token = None


def print_result(r):
    global token
    if r:
        u = json.loads(r)["u"].encode('utf-8')
        token = u.split('/')[-1]
        my_web.hide()
        my_app.quit()


def page_loaded(ok):
    if ok and my_web.url() == QUrl(u'https://services.nijmegen.nl/irma/issue?'):
        my_web.page().runJavaScript("document.getElementById(\"qrcode\").title", print_result)


my_web.loadFinished.connect(page_loaded)
my_web.load(QUrl("https://services.nijmegen.nl/irma/issue"))
my_web.setWindowTitle("Annoying Pop-up")
my_web.show()

my_app.exec_()


keylength = 1024
privkey, pubkey = GenerateKeyPair(DefaultSystemParameters[1024], 12, 0, time.time() + 365 * 24 * 3600)
secret = random.randint(0, (1 << pubkey.Params.Lm)-1)

no_pin = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=\\n'
nijmegen_pk = PublicKey(23083488486549897342445782144260418866406158141229353719774537109857602517531968360565665609467481891447560624076815171902701100966287957305108165359561949360083877250239403854264718766611914546598386861612569717342719970733534109259914224641827795583044198054215191403512923464817190740115084592218196237155110856960538232123516128837187213948108950948189326484086894617531775654632931500640447614251158847855339740827820438899588758225795818551948536549559056010847714888366215223136314103660472145888078608366824506752024906549838742531111980400035836315302127498031571363295588011197449677663889969586928901072313,
                        21996097562462986078062266760570839632368666336930449100710219193083169602638828235936199640645377909935072520733183249240046130457636624442062243451440224778516450621326296645864383200575465261390770884257869327113249994944452946726697068813837846309611522025015106114460166187849386838359114310736835179842082535077960748152462179828684501419555845992661755360582047348708156487399822399815666486200072325009844109861305319650267857884072236845579743902589253922700333979232264274987632158462781859079130242737403727986975262844227840629165720715934747858640865861457131368747734346685714519020418873843104916228280,
                        4947862832753626546478602156656842202057521619994473351955549881889207602254515780579851896480785866176480567148192586986100334505767781338275900563505746148671979076778245443483591399373882039328752028017854917379079054891520222455508866721143806902847716392398300907937800873646142753100571799865902982609152983892345581161682905177159947490777005402885835320472385464433388646950557370425813135940598630885703841092826465193638500872756113900936427031750894579870292971487619768646341710813702897859559036448628085495588328263274348731094037715519018033211802570787745672191089113391287690457105331872557937999400,
                        [
15808696382313521029498302941766526733977729427883195983125245826826173818975313729372504098991548495658555069715261219260888452805876317015185289959873871781847970421424092267390851286117805254793149672423462824319365513777297108636020303621860655680773041708552101900781525115954576633405037433294629405969757284000898223126408183516585343155580898696332575988626360125678311971998330836385076717225974667239213022081733679967828451967179246639482878339258861205349490250541707989209596190050065548195245789296809991450442034164728803158791580408688254194258294558674614912364910799520973505863309010350337215071224,
3623979528282973709241947655875335166699588279504401615834172594572546976865444231385452712230007383017790497510891709286264355728528335715792264895893532503216602953246487428262314577721458747422665073927269545059264734972099603211965187561236195576672102977197145104234638874886757303714645810537861535680786933786575739066078878156767960794812632645912631455489541206669647475476724281623495179298853536283827207003887936413165816406471338678833479248684553011735775444279630321017716568769184227853163353266962950176765174266376406150658104473708822348072326044568518460450501415193543098773066630972969788013002,
22634256348927655722809815085233043745100944436342687926925925166398759108895605190764701434213976771074907111818085183221351521638393255418615981622073207637548372380738503651991783279307378163201619827167104415191411261791912291265344978244323632540740036355066783770791347303011767716391683073397404369518856172096009614285174710104499165398313371122195804230932387723694099372179425846383026641055188422173075443079992057658548559543663875299165906426709578303516592727182956557092864756423390331560285586778974908444020442243202485656263863722188395693392594599739632680951999133849820821173711471766582009195439,
11256596166935038108949994481938338728879804608226903525770235886820923575210250920976759175243528966245758739162792824917979101378604893032790848631866906373658116535358235235074573286569901851371650039130154920704747059395018669342796133114722534411797979011314108284389224485298591418449728740439726045288445930406868719223280098143922546665466959899646725590912597165695347871412476105282697724469390141162189261753216547714867417926858276952217830743821024376812780270840259109746499296724111761676172829011794393620280043687234582370616779673186282094226929789479204464203053094534288794186523063142779201894812,
8328882840522559105372840114764524245718280845584685149581750174932302288701823575147482930366112298226726472752350080975180244394004398805171543926196382234066664952109484506329930824644533549087525609703895265524928433520229699701806961775588004502108013437553921611771017623823195463722202349140368331115261014065253891395542631451616382846713774839017185754461478720706428665649514040991350008856161748333406823614376753398812607792116603973034251918948312260051426641059124036658087545637416805786046569679335680794886321984280329613913483220919618146705865694420142678597766708270682100539809060232034633157315,
21170789466690102838632546687993921962308420400595254298711868265896203763830365698155519482420362654103260162764990492672336429945477189549290689393206934347695865817331602075241538888855797236425493661414698907977721412093519949998097488318355163873948278940703938127315504561313210692529033436007408586602681313079608495041092870860944363935133957510959127813352687125808100809195299314241697809983189981126197792010283359691442028164288687624663529912571365760506710900768963321441744112684029186246306606338512437185565297309957393569849205608638865807657601068338432857181424572424357245790895221117697058139826,
10743091358051163282888319641158178222007853022746226381673423512038649550116152372190187805754435869875607462115084875325956272522111954632472156593515394209770187057553242693568390116688771330129289932727890053466820164818822576217949579117058832254650311462487308563819753984101996521813342907961887183986147788687147668485770090147885060032854725601975887337251351742724369148339330535314465603803398712094039753926929449080245123252909741029684844496613182673511660457085237529378950504798739861417271997909406355270537786569640848180452558967254993605098395819800380780542985539304878743636609895472837905829857,
13954717378778863603049418529292770756960957248343333831581492269206254951318518524286447415699476612774597264474753154335432499831782720621425707648707580537231936214820419780313206289108838606363080824049098979739030993938301245537815996581674397003155824686525788948334786420871053968883552124636160465384477247266664808733278591248005498265577288919452308345548894026029694941946631675537622785801548052673548811435811976031874247268909073777788826992575353466344026160953773220200561103374017053012762650408111053715358216973621348063904375610219417937482126074289334511065850104108414883527126340024310084989841,
6564407801438593945869720171421662860980474660664912056336813648392074782172569303692943427403633010179611385500339485480724546120895967125348215906627085831722646363576045050751022001001004018269216400664537289447293467346657851412570366520740725268401268583540307917534900732027777312278053795271327279235355044117361426662614569413115829088287604140301001579054230730217349520950741153305990045836495773978758060736798138577240198325950284023757866614052697256816013755334386928484784866701468396144955813283666327736019334931252651432875641872522360983655890722679115901173952441306550920672709866788344702434515,
11960039745946413574575165760501519771761280866219418953799590332246981162251355061638728968538177999973796941999775549009246780385378622157665839618739242267840398979071522224661127462434860600430411968220336211959506918038198375923436216420496828598122761925459834735647878835153977389407295750761805192690045462871979781026769840452126114961957912496156665661892810971228552308474929864354844543624664342802982819200786379481439572593775905939730523962789191333831272733391339222926040402838646522772664593136550383297362885510218688666992303633730652663039250721765787074794716042677430164026113135574648911385189,
19746269179718038947278382817926391502718844818429850256586173048766493358468885936787505416464923968071262222408606814036778528690629783340675849659233897104782110015657045908454956829105293739688249687560362436095152506028415022071918496293826802270570854345118321091830347491602137421804369573635578071648060553452797048525836302279651741167693077200627547740823827109115161684751592329898180451339154143060179951860878683157578454450012151266205245678674075810010954117261292205107508603993624273647632144354571108080437660618064216133530656761759354948990669228345693878682087351857365630142712523683195538415066,
20033800821189856314352012966459139215459636510156321137813391257932532690918586903371473262651796673377905627552844136579861189804422885946023047954868300711444224079478190549793116711261764112713124864828714356116403710541589717793077404973237754546272449896465950640602732222765173787933649776578728711763181270363320950252470013730228575929539188340728297366348723368571151256520817411324884970239515744088268337272064297585749315398455730350365402770117757039456904404089941759873859478648716884602446166397304904330709556884400578858763491798730789048485392478855179155064983293617316398128615926445893453575449
                        ],
                        0, 1568208470)

def do_get(u):
    http = urllib3.PoolManager()
    headers = {'Content-Type': 'application/json',
               "X-IRMA-MinProtocolVersion": "2.4",
               "X-IRMA-MaxProtocolVersion": "2.4"}

    print "[HTTP GET]", u
    r = http.request('GET', u, headers=headers)
    try:
        out = json.loads(r.data)
    except ValueError:
        out = r.data
    print "(RESPONSE)", out
    return out


def do_post(u, content, extra_headers={}):
    http = urllib3.PoolManager()
    headers = {'Content-Type': 'application/json'}
    headers.update(extra_headers)

    print "[HTTP POST]", u
    print "(BODY)", content
    r = http.request('POST', u, headers=headers, body=content)
    try:
        out = json.loads(r.data)
    except ValueError:
        out = r.data
    print "(RESPONSE)", out
    return out


u = "https://keyshare.privacybydesign.foundation/tomcat/irma_keyshare_server/api/v1/client/register"
u = do_post(u, "{\"username\":\"\",\"pin\":\"%s\",\"email\":null,\"language\":\"en\"}" % no_pin)[u'u']
response = do_get(u)
context = int(binascii.hexlify(base64.b64decode(response[u"context"])), 16)
nonce = int(binascii.hexlify(base64.b64decode(response[u"nonce"])), 16)
irmaid = response[u"credentials"][0][u"attributes"][u"email"]
u = "https://keyshare.privacybydesign.foundation/tomcat/irma_keyshare_server/api/v1/users/verify/pin"
jwt = do_post(u, "{\"id\":\"%s\",\"pin\":\"%s\"}" % (irmaid, no_pin))[u"message"]
extra_headers = {"Authorization": jwt, "X-IRMA-Keyshare-Username": ""}
u = "https://keyshare.privacybydesign.foundation/tomcat/irma_keyshare_server/api/v1/prove/getCommitments"
response = do_post(u, "[{\"issuer\":{\"identifier\":\"pbdf.nijmegen\"},\"counter\": 0},{\"issuer\":{\"identifier\":\"pbdf.nijmegen\"},\"counter\": 0},{\"issuer\":{\"identifier\":\"pbdf.nijmegen\"},\"counter\": 0},{\"issuer\":{\"identifier\":\"pbdf.nijmegen\"},\"counter\": 0}]",extra_headers=extra_headers)
Pcommit = response[u'c'][0][1][u'Pcommit']
P = response[u'c'][0][1][u'P']

# Get nijmegen issuance
u = 'https://www.nijmegen.nl/personen/attributen/irma-server-api/api/v2/issue/%s' % token
issuance_output = do_get(u)
context = int(binascii.hexlify(base64.b64decode(issuance_output[u'context'])), 16)
nonce1 = int(binascii.hexlify(base64.b64decode(issuance_output[u'nonce'])), 16)
nonce2 = random.randint(0, (1 << pubkey.Params.Lstatzk)-1)

u = "https://keyshare.privacybydesign.foundation/tomcat/irma_keyshare_server/api/v1/prove/getResponse"
cbs = [CredentialBuilder(nijmegen_pk, context, secret, nonce1) for _ in range(4)]
for cb in cbs:
    cb.MergeProofPCommitment(ProofPCommitment(P, Pcommit))
challenge = Challenge(cbs, context, nonce1, False)
commit_jwt = do_post(u, str(challenge), extra_headers=extra_headers) #'"%d"' % (challenge)
proofP_d = commit_jwt.split('.')[1]
lens = len(proofP_d)
lenx = lens - (lens % 4 if lens % 4 else 4)
proofP_d = json.loads(base64.decodestring(proofP_d[:lenx]) + '}')[u"ProofP"]
P = proofP_d[u"P"]
c = proofP_d[u"c"]
s_response = proofP_d[u"s_response"]
proofP = ProofP(P, c, s_response)

u = 'https://www.nijmegen.nl/personen/attributen/irma-server-api/api/v2/issue/%s/status' % token

while do_get(u) != "CONNECTED":
    time.sleep(0.5)
    print "WAITING"

u = 'https://www.nijmegen.nl/personen/attributen/irma-server-api/api/v2/issue/%s/commitments' % token

proofs = BuildDistributedProofList(cbs, challenge, [])
commitMsg = IssueCommitmentMessage(None, proofs, nonce1)


def proof_to_str(proof):
    return ('{"U": ' + str(proof.U)
            + ', "c": ' + str(proof.C)
            + ', "v_prime_response": '+ str(proof.VPrimeResponse)
            + ', "s_response": ' + str(proof.SResponse) + '}')


outjson = '{'
outjson += '"U": null,'
outjson += '"combinedProofs": [' + ', '.join(proof_to_str(p) for p in commitMsg.Proofs) + '],'
outjson += '"indices": [],'
outjson += '"n_2": ' + str(commitMsg.Nonce2) + ","
outjson += '"proofPJwt": "",'
outjson += '"proofPJwts": {"pbdf": "'+ commit_jwt + '"}'
outjson += '}'

for p in proofs:
    p.MergeProofP(proofP, nijmegen_pk)
print "SELF TEST:", Verify(proofs, [nijmegen_pk]*4, context, nonce1, False)

output_proof = do_post(u, outjson)


class MainWindow(QMainWindow):

    def __init__(self, *args, **kwargs):
        global issuance_output, output_proof
        from pprint import pformat
        super(MainWindow, self).__init__(*args, **kwargs)
        self.setWindowTitle("Output")

        separator = '===='*20 + '\n'
        contents = '\n' + separator + 'Your attributes\n' + separator + pformat(issuance_output) + '\n' + separator + 'Non-Interactive Zero-Knowledge Proof\n' + separator + pformat(output_proof)

        label = QTextEdit("")
        label.setPlainText(contents)
        label.setAlignment(Qt.AlignCenter)
        self.setCentralWidget(label)


app = QApplication(sys.argv)
window = MainWindow()
window.showMaximized()
app.exec_()
